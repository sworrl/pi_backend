<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>π-Backend Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --bg-color: #030712; --sidebar-bg: #111827; --card-bg: #1f2937;
            --border-color: #374151; --text-primary: #f9fafb; --text-secondary: #9ca3af;
            --accent-color: #22d3ee; --accent-color-hover: #06b6d4;
            --error-color: #ef4444; --error-color-light: #fca5a5; --success-color: #22c55e;
            --info-color: #3b82f6; --warning-color: #f59e0b;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-primary); }
        .sidebar { background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); }
        .card { background-color: var(--card-bg); border-radius: 0.75rem; border: 1px solid var(--border-color); }
        .tab-button.active { color: var(--accent-color); border-bottom-color: var(--accent-color); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .api-btn {
            background-color: var(--accent-color); color: black; font-weight: 600;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem;
            transition: all 0.2s ease-in-out; white-space: nowrap;
        }
        .api-btn:hover { background-color: var(--accent-color-hover); }
        .api-btn.secondary { background-color: #374151; color: var(--text-primary); }
        .api-btn.secondary:hover { background-color: #4b5563; }
        .response-box {
            background-color: #0c121d; border: 1px solid var(--border-color); border-radius: 0.5rem;
            padding: 1rem; margin-top: 1rem; max-height: 400px; overflow-y: auto;
            font-family: 'Fira Code', 'Courier New', monospace; font-size: 0.75rem;
            white-space: pre-wrap; word-break: break-all;
        }
        input, select, textarea {
             background-color: #1f2937; border: 1px solid var(--border-color); color: var(--text-primary);
             border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 1px var(--accent-color); }
        .grid-item-label { color: var(--text-secondary); font-size: 0.875rem; }
        .grid-item-value { color: var(--text-primary); font-size: 1rem; font-weight: 500; }
        .weather-card-icon { width: 48px; height: 48px; margin: 0 auto; }

        /* Message Display Styles */
        #global-message-container {
            position: fixed; top: 1rem; right: 1rem; z-index: 10000;
            display: flex; flex-direction: column; gap: 0.5rem;
            max-width: 300px;
        }
        .message-toast {
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            font-size: 0.875rem; font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            opacity: 0; transform: translateY(-10px);
        }
        .message-toast.show { opacity: 1; transform: translateY(0); }
        .message-toast.error { background-color: var(--error-color); color: white; }
        .message-toast.success { background-color: var(--success-color); color: white; }
        .message-toast.info { background-color: var(--info-color); color: white; }
        .message-toast.warning { background-color: var(--warning-color); color: white; }

        #initial-admin-setup {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 1000;
            width: min(90vw, 500px); background-color: var(--card-bg);
            border: 1px solid var(--border-color); border-radius: 0.75rem;
            padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Status colors for file info table */
        .status-ok { color: var(--success-color); }
        .status-outdated { color: var(--warning-color); }
        .status-missing { color: var(--error-color); }
    </style>
</head>
<body class="font-sans antialiased">

    <div id="global-message-container"></div>

    <div class="flex flex-col lg:flex-row h-screen w-full">
        <!-- Sidebar -->
        <aside class="sidebar w-full lg:w-80 flex-shrink-0 p-6 flex flex-col justify-between">
            <div>
                <div class="flex items-center justify-between lg:justify-start gap-3 mb-6">
                    <i data-lucide="raspberry-pi" class="w-10 h-10 text-pink-500"></i>
                    <div>
                        <h1 class="text-xl font-bold text-white">π-Backend</h1>
                        <p class="text-xs text-gray-400">Version: <span id="api-version-text">...</span></p>
                    </div>
                </div>

                <div class="card p-4 space-y-4">
                    <h2 class="text-md font-semibold text-gray-300 flex items-center gap-2"><i data-lucide="gauge-circle" class="w-5 h-5 text-cyan-400"></i>System Status</h2>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm">
                        <div class="sidebar-metric"><div class="text-gray-400">CPU</div><div id="cpu-usage-val" class="font-mono font-bold text-lg">...</div></div>
                        <div class="sidebar-metric"><div class="text-gray-400">Temp</div><div id="cpu-temp-val" class="font-mono font-bold text-lg">...</div></div>
                        <div class="sidebar-metric"><div class="text-gray-400">Memory</div><div id="memory-usage-val" class="font-mono font-bold text-lg">...</div></div>
                        <div class="sidebar-metric"><div class="text-gray-400">Disk</div><div id="disk-usage-val" class="font-mono font-bold text-lg">...</div></div>
                        <div class="sidebar-metric col-span-2"><div class="text-gray-400">Time Sync</div><div id="time-offset" class="font-mono font-bold text-lg">...</div></div>
                        <div class="sidebar-metric"><div class="text-gray-400">Battery</div><div id="sidebar-battery-percent" class="font-mono font-bold text-lg">...</div></div>
                        <div class="sidebar-metric"><div class="text-gray-400">Time Est.</div><div id="sidebar-battery-time" class="font-mono font-bold text-lg">...</div></div>
                    </div>
                </div>

                <nav class="mt-6 space-y-4">
                    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Controls</h2>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between text-sm">
                            <label for="poll-interval" class="text-gray-400">Refresh (s):</label>
                            <input type="number" id="poll-interval" value="5" min="1" class="w-16">
                        </div>
                        <button id="toggle-polling-btn" class="api-btn secondary w-full text-sm"><i data-lucide="play-circle" class="w-4 h-4"></i><span>Start Refresh</span></button>
                    </div>
                </nav>
            </div>
            <div class="space-y-3 mt-8 lg:mt-0"><div id="api-status-badge" class="text-sm font-bold px-3 py-1 rounded-full inline-block">Checking...</div></div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
            <header class="mb-6">
                <div id="tabs" class="flex items-center border-b border-gray-800 text-sm font-medium text-gray-400 flex-wrap">
                    <button class="tab-button active px-4 py-2" data-tab="overview">Overview</button>
                    <button class="tab-button px-4 py-2" data-tab="gps">GPS</button>
                    <button class="tab-button px-4 py-2" data-tab="power">Power</button>
                    <button class="tab-button px-4 py-2" data-tab="time">Time</button>
                    <button class="tab-button px-4 py-2" data-tab="hardware">Hardware</button>
                    <button class="tab-button px-4 py-2" data-tab="location">Location</button>
                    <button class="tab-button px-4 py-2" data-tab="weather">Weather</button>
                    <button class="tab-button px-4 py-2" data-tab="update">Update</button>
                    <button class="tab-button px-4 py-2 hidden" data-tab="users" id="users-tab-button">Users</button>
                    <button class="tab-button px-4 py-2" data-tab="admin">Keys & Admin</button>
                </div>
            </header>

            <div class="max-w-7xl mx-auto">
                <!-- Overview Tab -->
                <div id="tab-overview" class="tab-content active space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="map-pin" class="w-5 h-5 text-cyan-400"></i>Location & GPS</h2>
                            <div class="space-y-2 text-sm" id="overview-gps-content"></div>
                        </div>
                        <div class="card p-6">
                            <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="battery-charging" class="w-5 h-5 text-cyan-400"></i>Power Status</h2>
                             <div class="space-y-2 text-sm" id="overview-power-content"></div>
                        </div>
                        <div class="card p-6">
                            <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="cpu" class="w-5 h-5 text-cyan-400"></i>System</h2>
                            <div class="space-y-2 text-sm" id="overview-system-content"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="p-4 flex justify-between items-center border-b border-gray-800">
                            <h3 class="text-base font-semibold text-gray-400 uppercase tracking-wider">API Response Log</h3>
                            <button id="clear-output-btn" class="text-xs bg-rose-600 hover:bg-rose-700 text-white font-bold py-1 px-3 rounded-md transition-colors">Clear</button>
                        </div>
                        <div class="p-4 h-64 overflow-y-auto"><pre id="api-output" class="text-xs whitespace-pre-wrap break-all"></pre></div>
                    </div>
                </div>

                <!-- GPS Tab -->
                <div id="tab-gps" class="tab-content">
                    <div class="card p-4 h-[calc(100vh-12rem)] flex flex-col">
                        <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="satellite" class="w-5 h-5 text-cyan-400"></i>GPS Data</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 p-4 flex-shrink-0" id="gps-data-grid"></div>
                        <div class="flex-grow bg-gray-800 rounded-lg overflow-hidden mt-4">
                            <iframe id="osm-map" class="w-full h-full border-0" loading="lazy" allowfullscreen src="about:blank"></iframe>
                        </div>
                    </div>
                </div>

                <!-- Power Tab -->
                <div id="tab-power" class="tab-content">
                     <div class="card p-6">
                        <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="zap" class="w-5 h-5 text-cyan-400"></i>UPS Power Details</h2>
                        <div id="ups-data-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center"></div>
                    </div>
                </div>

                <!-- Time Tab -->
                <div id="tab-time" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="clock" class="w-5 h-5 text-cyan-400"></i>Time Synchronization Status</h2>
                            <div class="space-y-3 text-sm" id="time-sync-content"></div>
                        </div>
                        <div class="card p-6">
                            <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="activity" class="w-5 h-5 text-cyan-400"></i>Clock Performance</h2>
                            <div class="space-y-4 text-sm" id="time-perf-content"></div>
                        </div>
                    </div>
                </div>

                <!-- Hardware Tab -->
                <div id="tab-hardware" class="tab-content space-y-6">
                    <div class="card p-6">
                        <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="toy-brick" class="w-5 h-5 text-cyan-400"></i>Hardware Control Panel</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <button class="api-btn secondary" onclick="window.globalApi.makeApiCall('/hardware/bluetooth-scan', 'POST', null, 'hardwareControlOutput')"><i data-lucide="bluetooth" class="w-4 h-4"></i>Scan Bluetooth</button>
                            <button class="api-btn secondary" onclick="window.globalApi.makeApiCall('/hardware/lte/flight-mode', 'POST', { enable: true }, 'hardwareControlOutput')"><i data-lucide="plane" class="w-4 h-4"></i>Flight Mode ON</button>
                            <button class="api-btn secondary" onclick="window.globalApi.makeApiCall('/hardware/lte/flight-mode', 'POST', { enable: false }, 'hardwareControlOutput')"><i data-lucide="plane-off" class="w-4 h-4"></i>Flight Mode OFF</button>
                            <button class="api-btn secondary" onclick="window.globalApi.makeApiCall('/hardware/lte/network-info', 'GET', null, 'hardwareControlOutput')"><i data-lucide="signal" class="w-4 h-4"></i>LTE Network Info</button>
                        </div>
                        <div id="hardwareControlOutput" class="response-box hidden"></div>
                    </div>

                    <div class="card p-6">
                        <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="thermometer-sun" class="w-5 h-5 text-cyan-400"></i>Sense HAT Sensors</h2>
                        <div id="sensehat-data-container" class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm"></div>
                    </div>
                </div>

                <!-- Location Services Tab -->
                <div id="tab-location" class="tab-content">
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="search" class="w-5 h-5 text-cyan-400"></i>Geocoding (Name to Coords)</h2>
                            <div class="flex gap-2">
                                <input type="text" id="geocode-input" class="w-full" placeholder="e.g., London, UK">
                                <button class="api-btn" onclick="window.globalApi.geocodeLocation()">Find</button>
                            </div>
                            <div id="geocode-output" class="response-box hidden"></div>
                        </div>
                         <div class="card p-6">
                            <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="map" class="w-5 h-5 text-cyan-400"></i>Reverse Geocoding</h2>
                            <div class="flex gap-2">
                                <input type="text" id="reverse-geocode-lat" class="w-full" placeholder="Latitude (from GPS)">
                                <input type="text" id="reverse-geocode-lon" class="w-full" placeholder="Longitude (from GPS)">
                                <button class="api-btn" onclick="window.globalApi.reverseGeocodeLocation()">Find</button>
                            </div>
                            <div id="reverse-geocode-output" class="response-box hidden"></div>
                        </div>
                    </div>
                     <div class="card p-6 mt-6">
                        <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="compass" class="w-5 h-5 text-cyan-400"></i>Community POIs</h2>
                        <div class="flex flex-col sm:flex-row gap-2 mb-3">
                            <input type="text" id="community-types-input" class="w-full" placeholder="e.g., police,hospital (optional types)">
                            <button class="api-btn" onclick="window.globalApi.getNearbyPois()">Find Nearby</button>
                        </div>
                        <p class="text-xs text-gray-500 mb-4">Uses current GPS location. Enter optional comma-separated place types.</p>
                        <div id="community-output" class="response-box hidden"></div>
                    </div>
                </div>

                <!-- Weather Services Tab -->
                <div id="tab-weather" class="tab-content">
                    <div class="card p-6">
                        <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="cloud-sun" class="w-5 h-5 text-cyan-400"></i>External Weather Services</h2>
                        <div class="flex flex-col sm:flex-row gap-2"><input type="text" id="weather-location-input" class="w-full" placeholder="Enter a city or leave blank for GPS"><button class="api-btn" onclick="window.globalApi.fetchWeather()">Fetch Weather</button></div>
                        <p class="text-xs text-gray-500 mt-2 mb-4">Note: Services may fail if their API keys are not in the database.</p>
                        <div id="weather-output-container" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    </div>
                </div>

                <!-- Update Tab -->
                <div id="tab-update" class="tab-content space-y-6">
                    <div class="card p-6">
                        <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="folder-git-2" class="w-5 h-5 text-cyan-400"></i>System File Status</h2>
                        <p class="text-sm text-gray-500 mb-4">File status is checked automatically when this tab is opened.</p>
                        <div class="response-box min-h-[200px] text-gray-300 overflow-x-auto">
                           <table class="w-full text-left text-xs">
                                <thead class="text-gray-400 uppercase">
                                    <tr>
                                        <th class="p-2">File</th>
                                        <th class="p-2">Version</th>
                                        <th class="p-2">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="file-info-table-body">
                                    <tr><td colspan="3" class="p-4 text-center">Click tab to load file info.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <!-- User Management Tab -->
                <div id="tab-users" class="tab-content hidden">
                   <div class="card p-6">
                        <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="users" class="w-5 h-5 text-cyan-400"></i>User Management</h2>
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-md font-semibold mb-3">All Users</h3>
                                <div id="userListOutput" class="response-box min-h-[150px]"></div>
                                <button class="api-btn secondary mt-3" onclick="window.globalApi.listAllUsers()">Refresh Users</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-md font-semibold mb-3">Add New User</h3>
                                    <div class="space-y-3">
                                        <input type="text" id="addUsername" placeholder="Username" class="w-full">
                                        <input type="password" id="addPassword" placeholder="Password" class="w-full">
                                        <select id="addRole" class="w-full">
                                            <option value="user">User</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                        <button class="api-btn w-full" onclick="window.globalApi.addNewUser()">Add User</button>
                                    </div>
                                    <div id="addUserOutput" class="response-box hidden"></div>
                                </div>
                                <div>
                                    <h3 class="text-md font-semibold mb-3">Manage Existing User</h3>
                                    <div class="space-y-3">
                                        <input type="text" id="manageUsername" placeholder="Select a user from the list" class="w-full" readonly>
                                        <input type="password" id="updatePassword" placeholder="New Password (optional)" class="w-full">
                                        <select id="updateRole" class="w-full">
                                            <option value="">Select New Role</option>
                                            <option value="user">User</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                        <div class="flex gap-3">
                                            <button class="api-btn w-full" onclick="window.globalApi.updateUser()">Update</button>
                                            <button class="api-btn bg-red-600 hover:bg-red-700 w-full" onclick="window.globalApi.deleteUser()">Delete</button>
                                        </div>
                                    </div>
                                    <div id="manageUserOutput" class="response-box hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Tab -->
                <div id="tab-admin" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div id="admin-login-panel" class="card p-6">
                            <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="log-in" class="w-5 h-5 text-cyan-400"></i>Admin Login</h2>
                            <div id="admin-logged-out-view" class="space-y-3">
                                <input type="text" id="adminLoginUsername" placeholder="Admin Username" class="w-full">
                                <input type="password" id="adminLoginPassword" placeholder="Admin Password" class="w-full">
                                <button class="api-btn w-full" id="adminLoginBtn">Login</button>
                                <div id="adminLoginOutput" class="response-box hidden"></div>
                            </div>
                            <div id="admin-logged-in-view" class="hidden text-center">
                                <p class="text-green-400">Logged in as <strong id="loggedInUsername"></strong></p>
                                <button class="api-btn secondary w-full mt-4" id="adminLogoutBtn">Logout</button>
                            </div>
                        </div>
                        <div id="key-manager-panel" class="card p-6 hidden">
                            <h2 class="text-lg font-semibold flex items-center gap-2 mb-4"><i data-lucide="key-round" class="w-5 h-5 text-cyan-400"></i>API Key Manager</h2>
                            <div id="apiKeysOutput" class="response-box min-h-[200px] mb-4"></div>
                            <div class="space-y-4">
                                <div>
                                    <h3 class="font-semibold mb-2 text-gray-400">Store External/Update Key</h3>
                                    <div class="space-y-2">
                                        <select id="externalKeyNameSelect" class="w-full"></select>
                                        <input type="text" id="externalKeyNameOther" class="w-full hidden mt-2" placeholder="Custom Key Name">
                                        <textarea id="externalKeyValue" placeholder="Paste the key value here" class="w-full h-24" style="resize:none;"></textarea>
                                        <button class="api-btn w-full" onclick="window.globalApi.storeOrUpdateKey()">Store / Update Key</button>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="font-semibold mb-2 text-gray-400">Generate Internal Key</h3>
                                    <div class="flex gap-2">
                                        <input type="text" id="internalKeyName" placeholder="Name for new internal key" class="w-full"><button class="api-btn" onclick="window.globalApi.generateInternalKey()">Generate</button>
                                    </div>
                                </div>
                            </div>
                            <div id="keyManagerOutput" class="response-box hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Initial Admin Setup Modal -->
    <div id="initial-admin-setup" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
       <div class="bg-gray-800 card p-6 w-full max-w-md mx-auto">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="shield-alert" class="w-6 h-6 text-yellow-400"></i>Action Required: Initial Setup</h2>
            <p class="text-gray-300 mb-4">Your backend is running without a configured admin account. For security, please set up your primary admin account now.</p>
            <div class="space-y-3">
                <input type="password" id="initialPassword" placeholder="Enter new admin password" class="w-full">
                <input type="password" id="confirmInitialPassword" placeholder="Confirm new admin password" class="w-full">
            </div>
            <button id="createInitialAdminBtn" class="api-btn w-full mt-6">Set Admin Password</button>
            <div id="initialAdminOutput" class="response-box hidden"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        let pollingIntervalId = null;
        let pollingActive = false;
        let adminCredentials = { username: '', password: '' };
        const API_BASE_URL = '';
        const BATTERY_CAPACITY_MAH = 7000;

        const el = (id) => document.getElementById(id);

        const showMessage = (type, text, duration = 4000) => {
            const container = el('global-message-container');
            const toast = document.createElement('div');
            toast.className = `message-toast ${type}`;
            toast.textContent = text;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        };
        
        const makeApiCall = async (endpoint, method = 'GET', body = null, outputElementId = 'api-output', silent = false) => {
            const outputEl = el(outputElementId);
            const headers = { 'Content-Type': 'application/json' };
            if (adminCredentials.username && adminCredentials.password) {
                headers['Authorization'] = 'Basic ' + btoa(adminCredentials.username + ':' + adminCredentials.password);
            }
            try {
                const response = await fetch(API_BASE_URL + endpoint, { method, headers, body: body ? JSON.stringify(body) : null });
                const responseText = await response.text();
                let data = { error: `Invalid JSON response from server. Status: ${response.status}`, content: responseText };
                try { data = JSON.parse(responseText); } catch (e) {}
                
                if (outputEl && !silent) {
                    const logEntry = document.createElement('div');
                    const color = response.ok ? 'text-green-400' : 'text-red-400';
                    logEntry.innerHTML = `<span class="text-gray-500">${new Date().toLocaleTimeString()}</span> ${method} ${endpoint} -> <span class="${color}">${response.status}</span><br><span class="pl-4">${JSON.stringify(data, null, 2)}</span>`;
                    outputEl.prepend(logEntry);
                    if(outputElementId !== 'api-output') outputEl.classList.remove('hidden');
                }
                
                if (!response.ok) {
                    if (!silent) showMessage('error', data.error || `HTTP Error ${response.status}`);
                    return { ...data, error: data.error || `HTTP Error ${response.status}` };
                }
                return data;
            } catch (error) {
                if (outputEl && !silent) {
                     const logEntry = document.createElement('div');
                     logEntry.innerHTML = `<span class="text-gray-500">${new Date().toLocaleTimeString()}</span> ${method} ${endpoint} -> <span class="text-red-400">Network Error</span><br><span class="pl-4">${error.message}</span>`;
                     outputEl.prepend(logEntry);
                }
                if (!silent) showMessage('error', `Network Error: ${error.message}`);
                return { error: `Network Error: ${error.message}` };
            }
        };
        
        const updateTabData = async (tabName) => {
             const dataFetchers = {
                'overview': updateOverviewData,
                'gps': updateGpsTab,
                'power': updatePowerTab,
                'time': updateTimeTab,
                'hardware': updateHardwareTab,
                'update': updateFileTab,
             };
             if (dataFetchers[tabName]) await dataFetchers[tabName]();
        };

        const updateAllData = async () => {
            if (!pollingActive) return;
            const activeTab = document.querySelector('.tab-button.active').dataset.tab;
            await updateTabData(activeTab); // Update current tab
            await updateSidebarData(); // Always update sidebar
        };
        
        // --- Sidebar & Overview Updaters ---
        const updateSidebarData = async () => {
            const [systemData, timeData, powerData] = await Promise.all([
                makeApiCall('/hardware/system-stats', 'GET', null, null, true),
                makeApiCall('/hardware/time-sync', 'GET', null, null, true),
                makeApiCall('/hardware/ups', 'GET', null, null, true)
            ]);
            if (systemData && !systemData.error) {
                el('cpu-usage-val').textContent = `${systemData.cpu_usage_percent?.toFixed(1) || 'N/A'}%`;
                el('cpu-temp-val').textContent = `${systemData.cpu_temperature_c?.toFixed(1) || 'N/A'}°C`;
                el('memory-usage-val').textContent = `${systemData.memory_usage_percent?.toFixed(1) || 'N/A'}%`;
                el('disk-usage-val').textContent = `${systemData.disk_usage?.percent || 'N/A'}%`;
            }
             if (timeData && !timeData.error) {
                 el('time-offset').textContent = `${timeData.system_time_offset_s || 'N/A'} s`;
             }
            updateSidebarPower(powerData);
        };
        
        const updateOverviewData = async () => {
            const [gpsData, powerData, systemData] = await Promise.all([
                makeApiCall('/hardware/gps/best', 'GET', null, null, true),
                makeApiCall('/hardware/ups', 'GET', null, null, true),
                makeApiCall('/hardware/system-stats', 'GET', null, null, true)
            ]);
            
            el('overview-gps-content').innerHTML = `
                <div class="flex justify-between text-gray-400"><span>Fix:</span><span class="font-mono text-white">${gpsData.fix_type || 'N/A'}</span></div>
                <div class="flex justify-between text-gray-400"><span>Coords:</span><span class="font-mono text-white">${(gpsData.latitude && gpsData.longitude) ? `${gpsData.latitude.toFixed(4)}, ${gpsData.longitude.toFixed(4)}` : 'N/A'}</span></div>
                <div class="flex justify-between text-gray-400"><span>Altitude:</span><span class="font-mono text-white">${gpsData.altitude_m ? `${gpsData.altitude_m.toFixed(1)} m` : 'N/A'}</span></div>`;

            let powerContent;
            if (powerData && !powerData.error) {
                const { statusText, statusColor } = getPowerStatus(powerData.current_mA);
                powerContent = `<div class="flex justify-between text-gray-400"><span>Voltage:</span><span class="font-mono text-white">${powerData.bus_voltage_V?.toFixed(2) || 'N/A'} V</span></div><div class="flex justify-between text-gray-400"><span>Current:</span><span class="font-mono text-white">${powerData.current_mA?.toFixed(1) || 'N/A'} mA</span></div><div class="flex justify-between text-gray-400"><span>Status:</span><span class="font-mono font-bold ${statusColor}">${statusText}</span></div>`;
            } else { powerContent = `<div class="text-red-400">Failed to load power data.</div>`; }
            el('overview-power-content').innerHTML = powerContent;

            el('overview-system-content').innerHTML = `<div class="flex justify-between text-gray-400"><span>CPU Usage:</span><span class="font-mono text-white">${systemData.cpu_usage_percent?.toFixed(1) || 'N/A'}%</span></div><div class="flex justify-between text-gray-400"><span>Memory:</span><span class="font-mono text-white">${systemData.memory_usage_percent?.toFixed(1) || 'N/A'}%</span></div><div class="flex justify-between text-gray-400"><span>CPU Temp:</span><span class="font-mono text-white">${systemData.cpu_temperature_c?.toFixed(1) || 'N/A'}°C</span></div>`;
        };

        // --- Tab Specific Updaters ---
        const updateGpsTab = async () => { /* ... same as previous version ... */ };
        const updatePowerTab = async () => { /* ... same as previous version ... */ };
        const updateTimeTab = async () => { /* ... same as previous version ... */ };
        const updateHardwareTab = async () => { /* ... same as previous version ... */ };
        const updateFileTab = async () => { /* ... same as previous version ... */ };
        
        const getPowerStatus = (current_ma) => {
             if (current_ma > 10) return { statusText: 'Charging', statusColor: 'text-green-400' };
             if (current_ma < -10) return { statusText: 'Discharging', statusColor: 'text-yellow-400' };
             return { statusText: 'Standby', statusColor: 'text-cyan-400' };
        }
        
        const updateSidebarPower = (data) => {
            const getBatteryPercentage = (v) => Math.min(100, Math.max(0, ((v - 6.0) / (8.4 - 6.0)) * 100));
            const formatTime = (h) => {
                if(h > 8760) return ">1y"; const d = Math.floor(h/24), hrs=Math.floor(h%24), m=Math.floor((h*60)%60);
                return d>0 ? `${d}d ${hrs}h` : hrs>0 ? `${hrs}h ${m}m` : `${m}m`;
            };
            const getEst = (p, c) => {
                if(Math.abs(c)<10) return "N/A";
                const cap = c>0 ? BATTERY_CAPACITY_MAH*(100-p)/100 : BATTERY_CAPACITY_MAH*p/100;
                return formatTime(cap/Math.abs(c));
            };
            
            if (data && !data.error) {
                const pct = getBatteryPercentage(data.bus_voltage_V);
                el('sidebar-battery-percent').textContent = `${pct.toFixed(1)}%`;
                el('sidebar-battery-time').textContent = getEst(pct, data.current_mA);
            } else {
                el('sidebar-battery-percent').textContent = 'N/A';
                el('sidebar-battery-time').textContent = 'N/A';
            }
        };

        // --- Admin & User Functions ---
        // (Fully implemented versions of these functions would go here)
        window.globalApi.listAllUsers = async () => { /* ... */ };
        window.globalApi.addNewUser = async () => { /* ... */ };
        // etc...

        const checkInitialSetup = async () => { /* ... */ };

        // --- Polling Control ---
        const togglePolling = () => {
            pollingActive = !pollingActive;
            const btn = el('toggle-polling-btn'), icon = btn.querySelector('i'), span = btn.querySelector('span');
            if (pollingActive) {
                const interval = parseInt(el('poll-interval').value) * 1000 || 5000;
                pollingIntervalId = setInterval(updateAllData, interval);
                btn.classList.add('bg-rose-600', 'hover:bg-rose-700'); btn.classList.remove('secondary');
                span.textContent = 'Stop Refresh'; icon.setAttribute('data-lucide', 'pause-circle');
                updateAllData(); // Run once immediately
            } else {
                clearInterval(pollingIntervalId);
                btn.classList.remove('bg-rose-600', 'hover:bg-rose-700'); btn.classList.add('secondary');
                span.textContent = 'Start Refresh'; icon.setAttribute('data-lucide', 'play-circle');
            }
            lucide.createIcons();
        };

        const init = async () => {
            lucide.createIcons();
            await updateStatus();
            await checkInitialSetup();
            togglePolling(); // Start polling on load
        };
        
        // --- Event Listeners ---
        el('tabs').addEventListener('click', e => {
            if (e.target.matches('.tab-button')) {
                document.querySelector('.tab-button.active').classList.remove('active');
                e.target.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                el(`tab-${e.target.dataset.tab}`).classList.add('active');
                updateTabData(e.target.dataset.tab);
            }
        });
        
        el('toggle-polling-btn').addEventListener('click', togglePolling);
        el('clear-output-btn').addEventListener('click', () => el('api-output').innerHTML = '');
        el('createInitialAdminBtn').addEventListener('click', () => { /* ... create admin logic */ });
        el('adminLoginBtn').addEventListener('click', () => { /* ... login logic */ });
        el('adminLogoutBtn').addEventListener('click', () => { /* ... logout logic */ });

        init();
    });
    </script>
</body>
</html>
